name: Operator Test Workflow
on:
  push:
    branches:
      - main
    paths:
      - operator/**
  pull_request:
    branches:
      - main
    paths:
      - operator/**
  workflow_dispatch:
    inputs:
      run-local-tests:
        description: 'Run local tests (in addition to OLM tests)'
        required: false
        default: true
        type: boolean
      skip-publish:
        description: 'Skip publishing to quay.io'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Shared image references for all jobs
  REGISTRY_APP_IMAGE: ttl.sh/apicurio-registry-${{ github.sha }}:8h
  IMAGE: ttl.sh/apicurio-registry-3-operator-${{ github.sha }}:8h
  BUNDLE_IMAGE: ttl.sh/apicurio-registry-3-operator-bundle-${{ github.sha }}:8h
  CATALOG_IMAGE: ttl.sh/apicurio-registry-3-operator-catalog-${{ github.sha }}:8h

jobs:

  # ============================================================================
  # Build job: Compiles everything and pushes images to ttl.sh
  # ============================================================================
  operator-build:
    name: Build Operator
    runs-on: ubuntu-latest
    if: github.repository_owner == 'Apicurio' && !contains(github.event.*.labels.*.name, 'DO NOT MERGE')
    steps:

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      # Build the operand image as well as the operator, otherwise the tests would not reflect changes in the current PR.
      - name: Build Java artifacts
        run: mvn -B clean package -pl app,distro/docker,operator/olm-tests -am -Pprod -DskipTests -Dmaven.javadoc.skip

      - name: Build and push operand image
        run: |
          docker build -f ./distro/docker/target/docker/Dockerfile.jvm -t "$REGISTRY_APP_IMAGE" ./distro/docker/target/docker
          docker push "$REGISTRY_APP_IMAGE"

      - name: Build and push operator image
        working-directory: operator
        run: |
          make image-build image-push

      - name: Build and push operator bundle
        working-directory: operator
        run: |
          make bundle

      - name: Build and push operator catalog
        working-directory: operator
        run: |
          make catalog

      # Upload operator target directory for test jobs
      - name: Upload operator build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: operator-build
          path: |
            operator/controller/target
            operator/model/target
            operator/olm-tests/target
          retention-days: 1

  # ============================================================================
  # Local tests job: Runs unit/integration tests locally (push or manual trigger)
  # ============================================================================
  operator-local-tests:
    name: Local Tests
    runs-on: ubuntu-latest
    needs: operator-build
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run-local-tests)
    steps:

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - uses: apicurio/apicurio-github-actions/setup-minikube@v2
        with:
          driver: 'none'
          ingress-enable: 'true'
          olm-enable: 'false'
          olm-v1-enable: 'false'
          start-args: '--alsologtostderr --v=2'

      - name: Build and run local tests on Minikube
        working-directory: operator
        run: |
          make BUILD_OPTS=--no-transfer-progress build

  # ============================================================================
  # OLM v1 tests job: Runs remote tests with OLM v1
  # ============================================================================
  operator-test-olm-v1:
    name: OLM v1 Tests
    runs-on: ubuntu-latest
    needs: operator-build
    steps:

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Download operator build artifacts
        uses: actions/download-artifact@v4
        with:
          name: operator-build
          path: operator

      - uses: apicurio/apicurio-github-actions/setup-minikube@v2
        with:
          driver: 'none'
          ingress-enable: 'true'
          olm-enable: 'false'
          olm-v1-enable: 'true'
          start-args: '--alsologtostderr --v=2'

      - name: Run OLM v1 remote tests on Minikube
        working-directory: operator
        run: |
          make BUILD_OPTS="--no-transfer-progress -Dtest.operator.olm-version=1" test-remote-all

      # Update and check install file in this job (only needs to run once)
      - name: Update install file
        working-directory: operator
        run: |
          # Unset the variables to generate a clean install file
          # See https://github.com/actions/runner/issues/1126
          unset REGISTRY_APP_IMAGE
          unset IMAGE
          unset BUNDLE_IMAGE
          unset CATALOG_IMAGE
          make IMAGE_TAG=latest-snapshot INSTALL_FILE=install/install.yaml dist-install-file

      - name: Check install file
        run: |
          git add operator/install/install.yaml || true
          if ! git diff --staged --exit-code; then
            echo 'Install file needs to be updated. Please run "cd operator; make SKIP_TESTS=true build IMAGE_TAG=latest-snapshot INSTALL_FILE=install/install.yaml dist-install-file" and commit the result.';
            exit 1;
          else
            echo "No changes to the install file.";
          fi

      # Uncomment if you need to debug the tests:
  #      - name: Install debug tools on failure
  #        if: failure()
  #        run: |
  #          NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  #          echo >> /home/runner/.bashrc
  #          echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> /home/runner/.bashrc
  #          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  #          brew install derailed/k9s/k9s
  #          . ~/.bashrc
  #          # Run tests e.g.:
  #          # make BUILD_OPTS=--no-transfer-progress test-remote-all &> 1.log &
  #          # tail -f 1.log
  #
  #      - name: Setup tmate session on failure
  #        if: failure()
  #        uses: mxschmitt/action-tmate@v3
  #        with:
  #          limit-access-to-actor: true

  # ============================================================================
  # OLM v0 tests job: Runs OLM v0 smoke tests (parallel with v1)
  # ============================================================================
  operator-test-olm-v0:
    name: OLM v0 Smoke Tests
    runs-on: ubuntu-latest
    needs: operator-build
    steps:

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Download operator build artifacts
        uses: actions/download-artifact@v4
        with:
          name: operator-build
          path: operator

      - uses: apicurio/apicurio-github-actions/setup-minikube@v2
        with:
          driver: 'none'
          ingress-enable: 'true'
          olm-enable: 'true'
          olm-v1-enable: 'false'
          start-args: '--alsologtostderr --v=2'

      - name: Run OLM v0 smoke tests on Minikube
        working-directory: operator
        run: |
          make BUILD_OPTS="--no-transfer-progress -Dgroups=OLM" test-remote-all

  # ============================================================================
  # Gate job: Waits for all test jobs to complete
  # ============================================================================
  operator-tests-complete:
    name: All Tests Complete
    runs-on: ubuntu-latest
    needs: [operator-test-olm-v1, operator-test-olm-v0, operator-local-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          # Check OLM v1 tests (required)
          if [ "${{ needs.operator-test-olm-v1.result }}" != "success" ]; then
            echo "OLM v1 tests failed"
            exit 1
          fi
          # Check OLM v0 tests (required)
          if [ "${{ needs.operator-test-olm-v0.result }}" != "success" ]; then
            echo "OLM v0 tests failed"
            exit 1
          fi
          # Check local tests (only required on push, skipped on PR)
          if [ "${{ needs.operator-local-tests.result }}" != "success" ] && [ "${{ needs.operator-local-tests.result }}" != "skipped" ]; then
            echo "Local tests failed"
            exit 1
          fi
          echo "All tests passed!"

  operator-publish:
    name: Publish Operator
    runs-on: ubuntu-latest
    needs: operator-tests-complete
    if: |
      needs.operator-tests-complete.result == 'success' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !inputs.skip-publish))
    steps:

      - name: Configure env. variables
        run: |
          # We want to use latest-snapshot instead of x.y.z-snapshot
          echo "IMAGE_TAG=latest-snapshot" >> $GITHUB_ENV
          echo "BUNDLE_IMAGE_TAG=latest-snapshot" >> $GITHUB_ENV
          echo "CATALOG_IMAGE_TAG=latest-snapshot" >> $GITHUB_ENV

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Build
        working-directory: operator
        run: |
          make BUILD_OPTS=--no-transfer-progress SKIP_TESTS=true build

      - name: Login to quay.io registry
        run: |
          docker login -u "${{ secrets.QUAY_USERNAME }}" -p "${{ secrets.QUAY_PASSWORD }}" quay.io

      # TODO: Also push to DockerHub Registry
      - name: Build and publish operator image
        working-directory: operator
        run: |
          make image-build image-push

      - name: Build and publish operator bundle
        working-directory: operator
        run: |
          make bundle

      - name: Build and publish operator catalog
        working-directory: operator
        run: |
          make catalog

  # Slack notification using reusable workflow
  notify-slack:
    name: Slack Notification
    needs: operator-publish
    if: always()
    uses: ./.github/workflows/reusable-notify-slack.yaml
    with:
      workflow-name: ${{ github.workflow }}
      job-name: 'operator-publish'
      job-status: ${{ needs.operator-publish.result }}
    secrets:
      SLACK_NOTIFICATION_WEBHOOK: ${{ secrets.SLACK_NOTIFICATION_WEBHOOK }}
      SLACK_ERROR_WEBHOOK: ${{ secrets.SLACK_ERROR_WEBHOOK }}
