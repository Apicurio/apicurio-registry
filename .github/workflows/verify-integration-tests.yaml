name: Integration Tests

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: '17'
      image-tag:
        type: string
        required: true
        description: 'Docker image tag to test'

jobs:
  # Consolidated by storage type to reduce concurrent runner usage (3 jobs instead of 11)
  integration-tests:
    name: Integration Tests (${{ matrix.storage }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        storage: [h2, postgresql, kafkasql]
        include:
          - storage: h2
            remote-profile: remote-mem
            image-prop: registry-in-memory-image
            profiles: "ci auth migration debezium-all"
          - storage: postgresql
            remote-profile: remote-sql
            image-prop: registry-sql-image
            profiles: "ci auth migration"
          - storage: kafkasql
            remote-profile: remote-kafka
            image-prop: registry-kafkasql-image
            profiles: "ci auth migration kafkasql-snapshotting"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - uses: apicurio/apicurio-github-actions/setup-minikube@v2

      - uses: apicurio/apicurio-github-actions/load-docker-image@v2
        with:
          artifact-name: 'apicurio-registry-${{ inputs.image-tag }}.tar'
          image-file: '/tmp/apicurio-registry-${{ inputs.image-tag }}.tar'
          minikube: 'true'
          image-name: 'apicurio/apicurio-registry'
          tag: '${{ inputs.image-tag }}'

      - name: Run Integration Tests (all profiles sequentially)
        run: |
          for profile in ${{ matrix.profiles }}; do
            echo "=========================================="
            echo "Running integration tests: ${{ matrix.storage }}-${profile}"
            echo "=========================================="
            ./mvnw verify -am --no-transfer-progress \
              -Pintegration-tests \
              -P${profile} \
              -P${{ matrix.remote-profile }} \
              -D${{ matrix.image-prop }}=apicurio/apicurio-registry:${{ inputs.image-tag }} \
              -pl integration-tests \
              -Dmaven.javadoc.skip=true
          done

      - name: Collect logs
        if: failure()
        run: sh ./.github/scripts/collect_logs.sh

      - name: Upload tests logs artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tests-logs-${{ matrix.storage }}
          path: artifacts
