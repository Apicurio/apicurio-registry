name: Publish Images

on:
  workflow_call:
    inputs:
      image-tag:
        type: string
        required: true
        description: 'Docker image tag (commit SHA)'
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_PASSWORD:
        required: true
      QUAY_USERNAME:
        required: true
      QUAY_PASSWORD:
        required: true

jobs:
  publish-app-image:
    name: Publish App Docker Image
    uses: ./.github/workflows/reusable-docker-build.yaml
    with:
      image-name: 'apicurio/apicurio-registry'
      dockerfile: './distro/docker/target/docker/Dockerfile.jvm'
      context: './distro/docker/target/docker'
      tag: 'latest-snapshot'
      maven-build: false
      download-artifact: 'build-artifacts-${{ inputs.image-tag }}'
      platforms: 'linux/amd64,linux/arm64'
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
      QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}

  publish-mcp-image:
    name: Publish MCP Server Docker Image
    uses: ./.github/workflows/reusable-docker-build.yaml
    with:
      image-name: 'apicurio/apicurio-registry-mcp-server'
      dockerfile: './mcp/target/docker/Dockerfile.jvm'
      context: './mcp/target/docker'
      tag: 'latest-snapshot'
      push-to-dockerhub: false
      maven-build: false
      download-artifact: 'build-artifacts-${{ inputs.image-tag }}'
      platforms: 'linux/amd64,linux/arm64'
    secrets:
      QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
      QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}

  publish-ui-image:
    name: Publish UI Docker Image
    uses: ./.github/workflows/reusable-docker-build.yaml
    with:
      image-name: 'apicurio/apicurio-registry-ui'
      dockerfile: './ui/Dockerfile'
      context: './ui'
      tag: 'latest-snapshot'
      npm-build: true
      npm-build-dir: 'ui'
      platforms: 'linux/amd64,linux/arm64'
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
      QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}

  publish-native-image:
    name: Publish Native Docker Image
    runs-on: ubuntu-22.04
    steps:
      - name: Download Native Docker Image
        uses: actions/download-artifact@v4
        with:
          name: apicurio-registry-native-${{ inputs.image-tag }}.tar
          path: /tmp

      - name: Load Native Docker Image
        run: |
          docker load -i /tmp/apicurio-registry-native-${{ inputs.image-tag }}.tar

      - name: Login to DockerHub Registry
        run: echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Login to Quay.io Registry
        run: docker login -u "${{ secrets.QUAY_USERNAME }}" -p "${{ secrets.QUAY_PASSWORD }}" quay.io

      - name: Tag and Push Native Image
        run: |
          # Tag for DockerHub
          docker tag apicurio/apicurio-registry-native:${{ inputs.image-tag }} docker.io/apicurio/apicurio-registry-native:latest-snapshot
          docker push docker.io/apicurio/apicurio-registry-native:latest-snapshot

          # Tag for Quay.io
          docker tag apicurio/apicurio-registry-native:${{ inputs.image-tag }} quay.io/apicurio/apicurio-registry-native:latest-snapshot
          docker push quay.io/apicurio/apicurio-registry-native:latest-snapshot
