name: Verify Registry Examples
on:
  push:
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'
      - 'README*'
      - 'docs/**'
      - '.github/workflows/**'
    branches: [ main ]
  pull_request:
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'
      - 'README*'
      - 'docs/**'
    branches: [ main]

jobs:
  build-examples:
    runs-on: ubuntu-20.04
    if: github.repository_owner == 'Apicurio'
    steps:
      - name: Checkout Code with Ref '${{ github.ref }}'
        uses: actions/checkout@v2
        with:
          path: apicurio-registry-examples

      - name: Checkout Apicurio Registry
        if: github.event_name == 'repository_dispatch'
        uses: actions/checkout@v2
        with:
          repository: Apicurio/apicurio-registry
          path: apicurio-registry

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check Dependency Tree
        run: cd apicurio-registry-examples && mvn dependency:tree --no-transfer-progress

      - name: Run Apicurio Registry application
        run: docker run -d -p 8080:8080 -it ttl.sh/${{ github.sha }}/apicurio/apicurio-registry:1d

      - name: Build Apicurio Registry with Examples
        if: github.event_name == 'repository_dispatch'
        run: cd apicurio-registry && mvn clean install -DskipTests -Pexamples

      - name: Google Chat Notification
        if: ${{ failure() }}
        uses: Co-qn/google-chat-notification@releases/v1
        with:
          name: ${{ github.workflow }}
          url: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          status: ${{ job.status }}
