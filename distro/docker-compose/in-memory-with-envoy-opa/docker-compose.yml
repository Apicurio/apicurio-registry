services:
  keycloak:
    container_name: keycloak-envoy-opa
    image: quay.io/keycloak/keycloak:23.0.7
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME: "localhost"
      KC_HOSTNAME_PORT: "8080"
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
    command:
      - start-dev
      - --import-realm
    ports:
      - 8080:8080
    volumes:
      - ../config/realm.json:/opt/keycloak/data/import/realm.json
    networks:
      - registry-network

  opa:
    container_name: opa-envoy-opa
    image: openpolicyagent/opa:latest-envoy
    command:
      - run
      - --server
      - --log-level=debug
      - --addr=0.0.0.0:8181
      - --diagnostic-addr=0.0.0.0:8282
      - --set=plugins.envoy_ext_authz_grpc.addr=:9191
      - --set=plugins.envoy_ext_authz_grpc.path=envoy/authz
      - --set=decision_logs.console=true
      - /policies/policy.rego
    ports:
      - 8181:8181
      - 9191:9191
    volumes:
      - ./policy.rego:/policies/policy.rego
    networks:
      - registry-network

  envoy:
    container_name: envoy-proxy
    image: envoyproxy/envoy:v1.28-latest
    command:
      - envoy
      - -c
      - /etc/envoy/envoy.yaml
      - --log-level
      - info
    ports:
      - 8081:8081
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml
    depends_on:
      - keycloak
      - opa
      - apicurio-registry
    networks:
      - registry-network

  apicurio-registry:
    image: apicurio/apicurio-registry:latest-snapshot
    container_name: apicurio-registry-api-envoy-opa
    environment:
      # Disable deletion for demo safety
      apicurio.rest.deletion.group.enabled: "true"
      apicurio.rest.deletion.artifact.enabled: "true"
      apicurio.rest.deletion.artifact-version.enabled: "true"

      # Disable OIDC authentication (Envoy handles this)
      QUARKUS_OIDC_TENANT_ENABLED: "false"

      # Enable proxy header authentication
      apicurio.authn.proxy-header.enabled: "true"
      apicurio.authn.proxy-header.username: "X-Forwarded-User"
      apicurio.authn.proxy-header.email: "X-Forwarded-Email"
      apicurio.authn.proxy-header.groups: "X-Forwarded-Groups"

      # CRITICAL: Trust proxy's authorization decisions
      apicurio.authn.proxy-header.trust-proxy-authorization: "true"

      # Disable local RBAC/OBAC (proxy handles authorization)
      apicurio.auth.role-based-authorization: "false"
      apicurio.auth.owner-only-authorization: "false"

      # Ensure no anonymous access
      apicurio.auth.anonymous-read-access.enabled: "false"
      apicurio.auth.authenticated-read-access.enabled: "false"

      # Configure trusted proxies
      quarkus.http.proxy.trusted-proxies: "envoy"
      quarkus.http.proxy.enable-forwarded-host: "true"
      quarkus.http.proxy.enable-forwarded-prefix: "true"

      # CORS configuration
      QUARKUS_HTTP_CORS_ORIGINS: "*"
      QUARKUS_PROFILE: "prod"
    expose:
      - "8080"
    networks:
      - registry-network

  apicurio-registry-ui:
    image: apicurio/apicurio-registry-ui:latest-snapshot
    container_name: apicurio-registry-ui-envoy-opa
    environment:
      # API URL points to Envoy (not directly to Registry)
      REGISTRY_API_URL: "http://localhost:8081/apis/registry/v3"

      # OIDC Authentication Configuration
      REGISTRY_AUTH_TYPE: "oidc"
      REGISTRY_AUTH_URL: "http://localhost:8080/realms/registry"
      REGISTRY_AUTH_CLIENT_ID: "apicurio-registry"
      REGISTRY_AUTH_REDIRECT_URL: "http://localhost:8888"

      # Authorization Configuration
      REGISTRY_AUTH_RBAC_ENABLED: "true"
      REGISTRY_AUTH_OBAC_ENABLED: "false"
    ports:
      - "8888:8080"
    depends_on:
      - envoy
      - keycloak
    networks:
      - registry-network

networks:
  registry-network:
    driver: bridge
