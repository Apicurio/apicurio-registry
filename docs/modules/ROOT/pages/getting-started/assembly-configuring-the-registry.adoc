// Metadata created by nebel
// Standard document attributes to be used in the documentation
//
// The following are shared by all documents

//:toc:
//:toclevels: 4
//:numbered:

// Branding - toggle upstream/downstream content "on/off"

// The following attributes conditionalize content from the Apicurio Registry project:
// * Upstream-only content tagged with ifdef::apicurio-registry[]...endif::[]
// * Downstream-only content tagged with ifdef::rh-service-registry[]...endif::[]
// Untagged content is common

// Upstream condition by default, switch on/off downstream-only
//:service-registry-downstream:

// upstream
:apicurio-registry:
:registry: Apicurio Registry
:registry-name-full: Apicurio Registry
:registry-version: 3.0
:registry-release: 3.0.0
:registry-docker-version: latest-release
:registry-v1: 1.3
:registry-v1-release: 1.3.2.Final
:registry-v2: 2.6.3
:operator-version: 1.1.0-v2.4.12.final
:kafka-streams: Strimzi
:registry-kafka-version: 3.5
:keycloak: Keycloak
:keycloak-version: 18.0
:kubernetes: Kubernetes
:kubernetes-with-article: a Kubernetes
:kubernetes-client: kubectl
:kubernetes-namespace: namespace

// downstream

//common
:context: registry
:version: 2024.Q2
:attachmentsdir: files
:registry-ocp-version: 4.14
:registry-db-version: 15
:registry-url: \http://MY_REGISTRY_UI_URL/

//integration products
:amq-version: 2.5
:productpkg: red_hat_integration

// Characters
:copy: ©
:infin: ∞
:mdash: —
:nbsp:
:ndash: –
:reg: ®
:trade: ™

//Include attributes for external linking
:LinkRedHatIntegrationDownloads: https://access.redhat.com/jbossnetwork/restricted/listSoftware.html?downloadType=distributions&product=red.hat.integration
:NameRedHatIntegrationDownloads: Red Hat Integration Downloads

:LinkOLMDocs: https://docs.openshift.com/container-platform/latest/operators/understanding/olm/olm-understanding-olm.html
:NameOLMDocs: Operator Lifecycle Manager

:LinkOperatorHub: https://docs.openshift.com/container-platform/latest/operators/understanding/olm-understanding-operatorhub.html
:NameOperatorHub: OperatorHub

// Service Registry titles
:ServiceRegistryURLVersion: 2024.q2
:RegistryProductURL: service_registry


:LinkServiceRegistryInstall: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/installing_and_deploying_{RegistryProductURL}_on_openshift/index
:NameServiceRegistryInstall: Installing and deploying {registry-name-full} on OpenShift

:LinkServiceRegistryUser: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/{RegistryProductURL}_user_guide/index
:NameServiceRegistryUser: {registry-name-full} User Guide

:LinkServiceRegistryMigration: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/migrating_{RegistryProductURL}_deployments/index
:NameServiceRegistryMigration: Migrating {registry-name-full} deployments

:LinkServiceRegistryRESTAPI: https://access.redhat.com/webassets/avalon/d/Red_Hat_build_of_Apicurio_Registry-3.0-Apicurio_Registry_User_Guide-en-US/files/registry-rest-api.htm
:NameServiceRegistryRESTAPI: Apicurio Registry v3 core REST API documentation



:LinkOpenShiftAddOperator: https://docs.openshift.com/container-platform/latest/operators/admin/olm-adding-operators-to-cluster.html
:NameOpenShiftAddOperator: Adding Operators to an OpenShift cluster

:LinkOpenShiftIntroOperator: https://docs.openshift.com/container-platform/latest/operators/understanding/olm-understanding-operatorhub.html
:NameOpenShiftIntroOperator: Understanding OperatorHub

// AMQ Streams titles
:StreamsName: AMQ Streams
:AMQStreamsURLVersion: 2.6

:LinkStreamsOpenShift: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/using_amq_streams_on_openshift/index
:NameStreamsOpenShift: Using {StreamsName} on OpenShift

:LinkDeployStreamsOpenShift: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/deploying_and_managing_amq_streams_on_openshift/index
:NameDeployStreamsOpenShift: Deploying and Managing {StreamsName} on OpenShift

:LinkStreamsRhel: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/using_amq_streams_on_rhel/index
:NameStreamsRhel: Using {StreamsName} on RHEL


// Debezium titles
:DebeziumURLVersion: 2023.q4

:LinkDebeziumInstallOpenShift: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/installing_change_data_capture_on_openshift/
:NameDebeziumInstallOpenShift: Installing Debezium on OpenShift

:LinkDebeziumInstallRHEL: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/installing_change_data_capture_on_rhel/
:NameDebeziumInstallRHEL: Installing Debezium on RHEL

:LinkDebeziumGettingStarted: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/getting_started_with_change_data_capture/index
:NameDebeziumGettingStarted: Getting Started with Debezium

:LinkDebeziumUserGuide: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/debezium_user_guide/index
:NameDebeziumUserGuide: Debezium User Guide

// Download URLs
:download-url-registry-container-catalog: https://catalog.redhat.com/software/containers/search
:download-url-registry-distribution: https://access.redhat.com/jbossnetwork/restricted/listSoftware.html?downloadType=distributions&product=red.hat.integration


// internal links
:registry-overview: xref:intro-to-the-registry_{context}[]
:registry-rules: xref:intro-to-registry-rules_{context}[]
:registry-artifact-reference: xref:registry-artifact-reference_{context}[]
:registry-rule-reference: xref:registry-rule-reference_{context}[]
:registry-config-reference: xref:registry-config-reference_{context}[]
:installing-the-registry-openshift: xref:installing-registry-ocp_{context}[]
:installing-the-registry-storage-openshift: xref:installing-registry-streams-storage_{context}[]
:managing-registry-artifacts-ui: xref:managing-registry-artifacts-ui_{context}[]
:managing-registry-artifacts-api: xref:managing-registry-artifacts-api_{context}[]
:managing-registry-artifacts-maven: xref:managing-registry-artifacts-maven_{context}[]
:rest-client: xref:using-the-registry-sdk_{context}[]
:kafka-client-serdes: xref:using-kafka-client-serdes_{context}[]
:registry-client-serdes-config: xref:configuring-kafka-client-serdes_{context}[]
:registry-rest-api: link:{attachmentsdir}/registry-rest-api.htm[Apicurio Registry REST API documentation]

:LinkRedHatIntegrationDownloads: https://access.redhat.com/jbossnetwork/restricted/listSoftware.html?downloadType=distributions&product=red.hat.integration
:NameRedHatIntegrationDownloads: Red Hat Integration Downloads

:LinkOLMDocs: https://docs.openshift.com/container-platform/latest/operators/understanding/olm/olm-understanding-olm.html
:NameOLMDocs: Operator Lifecycle Manager

:LinkOperatorHub: https://docs.openshift.com/container-platform/latest/operators/understanding/olm-understanding-operatorhub.html
:NameOperatorHub: OperatorHub

// Service Registry titles
:ServiceRegistryURLVersion: 2024.q2
:RegistryProductURL: service_registry


:LinkServiceRegistryInstall: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/installing_and_deploying_{RegistryProductURL}_on_openshift/index
:NameServiceRegistryInstall: Installing and deploying {registry-name-full} on OpenShift

:LinkServiceRegistryUser: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/{RegistryProductURL}_user_guide/index
:NameServiceRegistryUser: {registry-name-full} User Guide

:LinkServiceRegistryMigration: https://access.redhat.com/documentation/en-us/{productpkg}/{ServiceRegistryURLVersion}/html-single/migrating_{RegistryProductURL}_deployments/index
:NameServiceRegistryMigration: Migrating {registry-name-full} deployments

:LinkServiceRegistryRESTAPI: https://access.redhat.com/webassets/avalon/d/Red_Hat_build_of_Apicurio_Registry-3.0-Apicurio_Registry_User_Guide-en-US/files/registry-rest-api.htm
:NameServiceRegistryRESTAPI: Apicurio Registry v3 core REST API documentation



:LinkOpenShiftAddOperator: https://docs.openshift.com/container-platform/latest/operators/admin/olm-adding-operators-to-cluster.html
:NameOpenShiftAddOperator: Adding Operators to an OpenShift cluster

:LinkOpenShiftIntroOperator: https://docs.openshift.com/container-platform/latest/operators/understanding/olm-understanding-operatorhub.html
:NameOpenShiftIntroOperator: Understanding OperatorHub

// AMQ Streams titles
:StreamsName: AMQ Streams
:AMQStreamsURLVersion: 2.6

:LinkStreamsOpenShift: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/using_amq_streams_on_openshift/index
:NameStreamsOpenShift: Using {StreamsName} on OpenShift

:LinkDeployStreamsOpenShift: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/deploying_and_managing_amq_streams_on_openshift/index
:NameDeployStreamsOpenShift: Deploying and Managing {StreamsName} on OpenShift

:LinkStreamsRhel: https://access.redhat.com/documentation/en-us/red_hat_amq_streams/{AMQStreamsURLVersion}/html-single/using_amq_streams_on_rhel/index
:NameStreamsRhel: Using {StreamsName} on RHEL


// Debezium titles
:DebeziumURLVersion: 2023.q4

:LinkDebeziumInstallOpenShift: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/installing_change_data_capture_on_openshift/
:NameDebeziumInstallOpenShift: Installing Debezium on OpenShift

:LinkDebeziumInstallRHEL: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/installing_change_data_capture_on_rhel/
:NameDebeziumInstallRHEL: Installing Debezium on RHEL

:LinkDebeziumGettingStarted: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/getting_started_with_change_data_capture/index
:NameDebeziumGettingStarted: Getting Started with Debezium

:LinkDebeziumUserGuide: https://access.redhat.com/documentation/en-us/red_hat_integration/{DebeziumURLVersion}/html-single/debezium_user_guide/index
:NameDebeziumUserGuide: Debezium User Guide

[id="configuring-the-registry_{context}"]
= Configuring your {registry} deployment

[role="_abstract"]
This chapter explains how to set important configuration options for your {registry} deployment. This includes features such as the {registry} web console, logging, and health checks:

* xref:configuring-registry-ui_{context}[]
* xref:configuring-liveness-readiness-probes_{context}[]
* xref:registry-liveness-env-vars_{context}[]

NOTE: For a list of all available configuration options, see {registry-config-reference}.

//INCLUDES
:leveloffset: +1


[id="configuring-registry-ui_{context}"]
= Configuring the {registry} web console

[role="_abstract"]
You can set optional environment variables to configure the {registry} web console specifically for your deployment environment or to customize its behavior.

.Prerequisites
* You have already installed {registry}.

[discrete]
== Configuring the web console deployment environment

When you access the {registry} web console in your browser, some initial configuration settings are loaded. The following configuration settings are required:

* URL for core {registry} server REST API v3

Typically the {registry} operator will automatically configure the UI component with the REST API v3 URL.  However, you can override this value by configuring the appropriate environment variable in the UI component deployment configuration.

.Procedure
Configure the following environment variables to override the default URL:

* `REGISTRY_API_URL`: Specifies the URL for the core {registry} server REST API v3. For example, `\https://registry-api.my-domain.com/apis/registry/v3`

[discrete]
== Configuring the web console in read-only mode

You can configure the {registry} web console in read-only mode as an optional feature. This mode disables all features in the {registry} web console that allow users to make changes to registered artifacts. For example, this includes the following:

* Creating a group
* Creating an artifact
* Uploading a new artifact version
* Updating artifact metadata
* Deleting an artifact

.Procedure
Configure the following environment variable:

* `REGISTRY_FEATURE_READ_ONLY`: Set to `true` to enable read-only mode. Defaults to `false`.

:leveloffset!:
:leveloffset: +1

// Metadata created by nebel
// ParentAssemblies: assemblies/getting-started/as_installing-the-registry.adoc

[id="configuring-liveness-readiness-probes_{context}"]

== Configuring {registry} health checks on OpenShift

[role="_abstract"]
You can configure optional environment variables for liveness and readiness probes to monitor the health of the {registry} server on OpenShift:

* _Liveness probes_ test if the application can make progress. If the application cannot make progress, OpenShift automatically restarts the failing Pod.

* _Readiness probes_ test if the application is ready to process requests. If the application is not ready, it can become overwhelmed by requests, and OpenShift stops sending requests for the time that the probe fails. If other Pods are OK, they continue to receive requests.

IMPORTANT: The default values of the liveness and readiness environment variables are designed for most cases and should only be changed if required by your environment. Any changes to the defaults depend on your hardware, network, and amount of data stored. These values should be kept as low as possible to avoid unnecessary overhead.

.Prerequisites
* You must have an OpenShift cluster with cluster administrator access.
* You must have already installed {registry} on OpenShift.
* You must have already installed and configured your chosen {registry} storage in either {kafka-streams} or PostgreSQL.

.Procedure

. In the OpenShift Container Platform web console, log in using an account with cluster administrator privileges.

. Click *Installed Operators* > *{registry}*.

. On the *ApicurioRegistry* tab, click the Operator custom resource for your deployment, for example, *example-apicurioregistry*.

. In the main overview page, find the *Deployment Name* section and the corresponding `DeploymentConfig` name for your {registry} deployment, for example, *example-apicurioregistry*.

. In the left navigation menu, click *Workloads* > *Deployment Configs*, and select your `DeploymentConfig` name.

. Click the *Environment* tab, and enter your environment variables in the *Single values env* section, for example:
** *NAME*: `LIVENESS_STATUS_RESET`
** *VALUE*: `350`

. Click *Save* at the bottom.
+
Alternatively, you can perform these steps using the OpenShift `oc` command. For more details, see the link:https://docs.openshift.com/container-platform/{registry-ocp-version}/cli_reference/openshift_cli/getting-started-cli.html[OpenShift CLI documentation].

[role="_additional-resources"]
.Additional resources
* xref:registry-liveness-env-vars_{context}[]
* link:https://docs.openshift.com/container-platform/{registry-ocp-version}/applications/application-health.html[OpenShift documentation on monitoring application health]
//* TBD

:leveloffset!:
:leveloffset: +1

// Metadata created by nebel
// ParentAssemblies: assemblies/getting-started/as_registry-reference.adoc

[id="registry-liveness-env-vars_{context}"]
= Environment variables for {registry} health checks

This section describes the available environment variables for {registry} health checks on OpenShift. These include liveness and readiness probes to monitor the health of the {registry} server on OpenShift. For an example procedure, see xref:configuring-liveness-readiness-probes_{context}[].

IMPORTANT: The following environment variables are provided for reference only. The default values are designed for most cases and should only be changed if required by your environment. Any changes to the defaults depend on your hardware, network, and amount of data stored. These values should be kept as low as possible to avoid unnecessary overhead.

[discrete]
== Liveness environment variables

.Environment variables for {registry} liveness probes
//[%header,cols="5,5,2,5"]
[.table-expandable,width="100%",cols="5,5,2,5",options="header"]
|===
|Name
|Description
|Type
|Default
|`LIVENESS_ERROR_THRESHOLD`
|Number of liveness issues or errors that can occur before the liveness probe fails.
|Integer
|`1`
|`LIVENESS_COUNTER_RESET`
|Period in which the threshold number of errors must occur. For example, if this value is 60 and the threshold is 1, the check fails after two errors occur in 1 minute
|Seconds
|`60`
|`LIVENESS_STATUS_RESET`
|Number of seconds that must elapse without any more errors for the liveness probe to reset to OK status.
|Seconds
|`300`
|`LIVENESS_ERRORS_IGNORED`
|Comma-separated list of ignored liveness exceptions.
|String
|`io.grpc.StatusRuntimeException,org.apache.kafka.streams.errors.InvalidStateStoreException`
|===

NOTE: Because OpenShift automatically restarts a Pod that fails a liveness check, the liveness settings, unlike readiness settings, do not directly affect behavior of {registry} on OpenShift.

[discrete]
== Readiness environment variables

.Environment variables for {registry} readiness probes
//[%header,cols="4,5,2,2"]
[.table-expandable,width="100%",cols="4,5,2,2",options="header"]
|===
|Name
|Description
|Type
|Default
|`READINESS_ERROR_THRESHOLD`
|Number of readiness issues or errors that can occur before the readiness probe fails.
|Integer
|`1`
|`READINESS_COUNTER_RESET`
|Period in which the threshold number of errors must occur. For example, if this value is 60 and the threshold is 1, the check fails after two errors occur in 1 minute.
|Seconds
|`60`
|`READINESS_STATUS_RESET`
|Number of seconds that must elapse without any more errors for the liveness probe to reset to OK status. In this case, this means how long the Pod stays not ready, until it returns to normal operation.
|Seconds
|`300`
|`READINESS_TIMEOUT`
a|Readiness tracks the timeout of two operations:

* How long it takes for storage requests to complete
* How long it takes for HTTP REST API requests to return a response

If these operations take more time than the configured timeout, this is counted as a readiness issue or error. This value controls the timeouts for both operations.
|Seconds
|`5`
|===


.Additional resources
* xref:configuring-liveness-readiness-probes_{context}[]
* link:https://docs.openshift.com/container-platform/{registry-ocp-version}/applications/application-health.html[OpenShift documentation on monitoring application health]
//* TBD

:leveloffset!:
