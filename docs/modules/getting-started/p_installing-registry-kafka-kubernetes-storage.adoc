// Metadata created by nebel
// ParentAssemblies: assemblies/getting-started/as_installing-the-registry.adoc

[id="installing-registry-kafka-kubernetes-storage"]
ifdef::apicurio-registry[]
= Installing {registry} with Apache Kafka storage on OpenShift

This topic explains how to install and run {registry} with storage in Apache Kafka on OpenShift from a container image using Strimzi. This storage option is suitable for production environments. 

The following versions are supported:

* Apache Kafka 2.2.x
* Apache Kafka 2.3
endif::[]

ifdef::rh-service-registry[]
=  Installing {registry} with AMQ Streams storage on OpenShift

This topic explains how to install and run {registry} with storage in Red Hat AMQ Streams on OpenShift from a container image. This storage option is suitable for production environments. 

The following versions are supported:

* Red Hat AMQ Streams 1.3
endif::[]

.Prerequisites

ifdef::apicurio-registry[]
* You must have a Kubernetes or OpenShift cluster with cluster administrator access.

* Ensure that you can connect to the {registry} container image in GitHub: link:https://hub.docker.com/r/apicurio/apicurio-registry-kafka[].
* You must have installed and deployed Strimzi on your Kubernetes or OpenShift cluster. For example: 
+
[source,bash]
----
minikube start --memory="8000m"
kubectl create namespace kafka
curl -L https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.14.0/strimzi-cluster-operator-0.14.0.yaml \
  | sed 's/namespace: .*/namespace: kafka/' \
  | kubectl apply -f - -n kafka
kubectl apply -f kubernetes/resources.yaml
kubectl wait kafka/my-cluster --for=condition=Ready --timeout=300s -n kafka
----
+ 
For more details, see https://strimzi.io/docs/quickstart/master/
endif::[] 

ifdef::rh-service-registry[]
* You must have an OpenShift cluster with cluster administrator access. {registry} and AMQ Streams support OpenShift versions 3.11 and 4.x.
* You must have already installed Red Hat AMQ Streams on your OpenShift cluster. For details, see: 
** link:https://access.redhat.com/documentation/en-us/red_hat_amq/7.5/html/using_amq_streams_on_openshift/getting-started-str?lb_target=stage[Getting Started with AMQ Streams]  
** link:https://developers.redhat.com/blog/2018/10/29/how-to-run-kafka-on-openshift-the-enterprise-kubernetes-with-amq-streams[How to run Kafka on OpenShift with AMQ Streams]
* Ensure that you can access the 
link:https://access.redhat.com/containers/#/registry.access.redhat.com/fuse7-tech-preview/fuse-service-registry-rhel7[{registry} container image in the Red Hat Container Catalog].
endif::[]

.Procedure
ifdef::apicurio-registry[]
. Copy the link:https://github.com/Apicurio/apicurio-registry/blob/1.0.x/distro/openshift-template/apicurio-registry-template-kafka.yml[{registry} OpenShift template].
. Edit the template as needed. For example: 
 ** `Template Parameters`: For `REGISTRY_ROUTE`, update the `value` to the domain for your registry API (for example, `registry.example.com`).
endif::[]

ifdef::rh-service-registry[]
//. Get the {registry} container image by following the link:https://access.redhat.com/containers/?tab=images#/registry.access.redhat.com/fuse7-tech-preview/fuse-service-registry-rhel7[instructions in the Red Hat Container Catalog]. 
. Copy the 
link:https://github.com/Apicurio/apicurio-registry/blob/1.0.x-redhat/distro/openshift-template/service-registry-template.yml[{registry} OpenShift template].
. Edit your template file as needed. For example: 
 ** `Image Streams for the components`: Update the image `name` to match the link:https://access.redhat.com/containers/#/registry.access.redhat.com/fuse7-tech-preview/fuse-service-registry-rhel7[{registry} container image in the Red Hat Container Catalog].  
 ** `Template Parameters`: For `REGISTRY_ROUTE`, update the `value` to the domain for your registry API (for example, `registry.example.com`).
. Create a new OpenShift application and specify the following arguments: 

** `service-registry-template.yml`: The OpenShift template file for {registry}
** `KAFKA_BOOTSTRAP_SERVERS`: The address of the Kafka bootstrap service (`my-cluster-kafka-bootstrap`) and the port number of the Kafka broker (`9092`)  
+
For example: 
+
[source,bash]
----
$ oc new-app service-registry-template.yml -p KAFKA_BOOTSTRAP_SERVERS=my-cluster-kafka-bootstrap:9092
----
+
You should see output such as the following: 
+
----
Deploying template "myproject/service-registry" for "service-registry-template.yml" to project myproject

    service-registry
    ---------
    Congratulations on deploying Service Registry into OpenShift!
    
    All components have been deployed and configured.

    * With parameters:
       * Registry Route Name=registry.example.com
       * Registry Max Memory Limit=1300Mi
       * Registry Memory Requests=600Mi
       * Registry Max CPU Limit=1
       * Registry CPU Requests=100m
       * Kafka Bootstrap Servers=my-cluster-kafka-bootstrap:9092

--> Creating resources ...
   imagestream.image.openshift.io "registry" created
   service "service-registry" created
   deploymentconfig.apps.openshift.io "service-registry" created
   route.route.openshift.io "service-registry" created
--> Success
   Access your application via route 'registry.example.com' 
   Run 'oc status' to view your app.
----
endif::[]

ifdef::apicurio-registry[]
. Create a new OpenShift application and specify the following arguments: 
+
** `apicurio-registry-template-kafka`: The OpenShift template file for {registry}
** `KAFKA_BOOTSTRAP_SERVERS`: The cluster IP address from the previous step and the port for your Kafka broker (`9092`)  
+
For example: 
+
[source,bash]
----
$ oc new-app apicurio-registry-template-kafka.yml -p KAFKA_BOOTSTRAP_SERVERS={KAFKA_CLUSTER_IP_ADDR}:9092
----
endif::[]

. Send a test request using the {registry} REST API. For example, enter the following `curl` command to create a simple schema artifact:
+
[source,bash]
----
$ curl -X POST -H "Content-Type: application/json" --data '{"id": "Procurement Invoice", "name": "My Invoice", "description": "My invoice description", "type": "AVRO", "version": 1}' registry.example.com/artifacts 
----
. Verify that the response includes the expected JSON body. For example:
+
[source,bash]
----
{"createdOn":1571757704485,"modifiedOn":1571757704485,"id":"448bc6fe-bbf6-41c9-ba35-1a96a0d198bf","version":1,"type":"AVRO"}
----

.Additional resources
* For more REST API sample requests, see the link:files/registry-rest-api.htm[Registry REST API documentation].
ifdef::rh-service-registry[]
* For more details on AMQ Streams, see link:https://access.redhat.com/documentation/en-us/red_hat_amq/7.5/html/using_amq_streams_on_openshift/index?[Using AMQ Streams on OpenShift].
endif::[]
* For more details on OpenShift templates, see the link:https://docs.openshift.com/container-platform/4.2/openshift_images/using-templates.html[OpenShift user documention].
* For a demo based on storage in Apache Kafka Streams, see the link:https://github.com/Apicurio/apicurio-registry-demo[Registry demo].
