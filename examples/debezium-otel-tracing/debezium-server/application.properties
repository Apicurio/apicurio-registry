# Debezium Server Configuration for PostgreSQL CDC with OpenTelemetry
# This configuration uses Debezium Server (Quarkus-based) instead of Kafka Connect
# for better OpenTelemetry integration

# =============================================================================
# Sink Configuration - Apache Kafka
# =============================================================================
debezium.sink.type=kafka
debezium.sink.kafka.producer.bootstrap.servers=kafka:29092
debezium.sink.kafka.producer.key.serializer=org.apache.kafka.common.serialization.StringSerializer
# ByteArraySerializer since debezium.format.value=avro produces Avro bytes
debezium.sink.kafka.producer.value.serializer=org.apache.kafka.common.serialization.ByteArraySerializer

# =============================================================================
# Source Configuration - PostgreSQL Connector
# =============================================================================
debezium.source.connector.class=io.debezium.connector.postgresql.PostgresConnector
debezium.source.database.hostname=postgres-orders
debezium.source.database.port=5432
debezium.source.database.user=orderuser
debezium.source.database.password=orderpass
debezium.source.database.dbname=orders
debezium.source.topic.prefix=dbserver1
debezium.source.table.include.list=public.orders
debezium.source.plugin.name=pgoutput
debezium.source.slot.name=orders_slot
debezium.source.publication.name=orders_publication
# Skip initial snapshot to ensure schema registration happens with order trace context
debezium.source.snapshot.mode=never

# Offset storage (file-based for simplicity)
debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
debezium.source.offset.flush.interval.ms=10000

# Schema history storage (for PostgreSQL with pgoutput, not strictly needed but good practice)
debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat

# =============================================================================
# Transforms - Activate OTEL tracing and extract new record state
# =============================================================================
# Use custom OTEL SMT (not built-in OpenTracing) for proper Java Agent integration
debezium.transforms=oteltracing,unwrap
debezium.transforms.oteltracing.type=io.apicurio.registry.examples.debezium.converter.OtelActivateTracingSpan
debezium.transforms.oteltracing.tracing.operation.name=debezium-cdc-orders
debezium.transforms.oteltracing.tracing.span.context.field=tracingspancontext
debezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
debezium.transforms.unwrap.drop.tombstones=true
debezium.transforms.unwrap.add.fields=op

# =============================================================================
# Format Configuration - Avro with Apicurio Registry
# =============================================================================
# The format converter handles Avro serialization and schema registration
# Note: Using base URL only - Debezium Server's Avro format internally appends the API path
debezium.format.key=json
debezium.format.value=avro
debezium.format.value.apicurio.registry.url=http://apicurio-registry:8080/apis/registry/v2
debezium.format.value.apicurio.registry.auto-register=true
# Enable global ID in message body (Confluent-compatible wire format)
debezium.format.value.apicurio.registry.use-id=globalId
debezium.format.value.apicurio.registry.as-confluent=true

# =============================================================================
# OpenTelemetry Configuration (Quarkus native)
# =============================================================================
quarkus.otel.sdk.disabled=false
quarkus.otel.exporter.otlp.endpoint=http://otel-collector:4317
quarkus.otel.exporter.otlp.protocol=grpc
quarkus.otel.service.name=debezium-server
quarkus.otel.traces.sampler=always_on

# =============================================================================
# Quarkus Configuration
# =============================================================================
quarkus.http.port=8080
quarkus.log.level=INFO
quarkus.log.category."io.debezium".level=INFO
