{{- /*
Encode an imagePullSecret string.
It takes params:

  .dockerconfigjson: {{ printf "{\"auths\":{\"%s\":{\"auth\":\"%s\"}}}" $registry (printf "%s:%s" $username $password | b64enc) | b64enc }}
  {{ printf "{\"auths\":{\"%s\":{\"auth\":\"%s\"}}}" $registry $string | b64enc }}
  '{"auths":{"us.gcr.io":{"username":"_json_key","password":"{{ (.Files.Get $root.Values.imagePullSecret.jsonfiie).AsConfig | quote }}","email":"not@val.id","auth":{{ $root.Files.Get $root.Values.imagePullSecret.jsonfiie | quote | b64enc }}"}}}'

imagePullSecret:
  email:
  registry:
  username:
  jsonfiie:
*/ -}}

{{- define "common.imagepullsecret.tpl" -}}
{{- $root := . -}}
{{- $registry := $root.Values.imagePullSecret.registry | default "us.gcr.io" -}}
{{- $username := $root.Values.imagePullSecret.username | default "_json_key" -}}
{{- $email := $root.Values.imagePullSecret.email | default "not@val.id" -}}
{{- $password := $root.Files.Get $root.Values.imagePullSecret.jsonfiie | quote -}}
{{- $auth := $root.Files.Get $root.Values.imagePullSecret.jsonfiie | quote | b64enc -}}
apiVersion: v1
kind: Secret
{{ template "common.metadata" . }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson:  |-
{{ printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"email\":\"%s\",\"auth\":\"%s\"}}}" $registry $username $password $email $auth | b64enc | indent 4 }}
{{- end -}}
{{- define "common.imagepullsecret" -}}
{{- template "common.util.merge" (append . "common.imagepullsecret.tpl") -}}
{{- end }}


{{- /*
Encode an jsonPullSecret string.
It takes params:

jsonPullSecret:
  jsonfiie:
  jsonfilename:
*/ -}}

{{- define "common.jsonPullSecret.tpl" -}}
{{- $root := . -}}
{{- $jsonfilename := $root.Values.jsonPullSecret.jsonfilename -}}
apiVersion: v1
kind: Secret
{{ template "common.metadata" . }}
type: Opaque
data:
  {{ $jsonfilename }}: |-
      {{ $root.Files.Get $root.Values.jsonPullSecret.jsonfiie | b64enc | indent 4 -}}
{{- end -}}
{{- define "common.jsonPullSecret" -}}
{{- $top := first . -}}
{{- if $top.Values.jsonPullSecret.enabled -}}
{{- include "common.util.merge" (append . "common.jsonPullSecret.tpl") -}}
{{- end }}
{{- end }}


{{- /*
  Encode an dockerPullSecret string.

dockerPullSecret:
  email:
  registry:
  username:
  password:
*/ -}}
{{- define "common.dockerpullsecret.tpl" -}}
{{- $root := . -}}
{{- $registry := $root.Values.dockerPullSecret.registry | default "us.gcr.io" -}}
{{- $username := $root.Values.dockerPullSecret.username | default "_json_key" | quote | b64enc -}}
{{- $email := $root.Values.dockerPullSecret.email | default "not@val.id" -}}
{{- $password := $root.Values.dockerPullSecret.password | quote | b64enc -}}
apiVersion: v1
kind: Secret
{{ template "common.metadata" . }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson:  |-
{{ printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"email\":\"%s\"}}}" $registry $username $password $email | b64enc | indent 4 }}
{{- end -}}
{{- define "common.dockerpullsecret" -}}
{{- template "common.util.merge" (append . "common.dockerpullsecret.tpl") -}}
{{- end }}
